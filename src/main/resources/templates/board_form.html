<!-- ê¸°ë³¸ ë ˆì´ì•„ì›ƒ(layout.html)ì„ ìƒì† -->
<html layout:decorate="~{layout}" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout">

<div layout:fragment="content" class="container">

  <h5 class="my-3 border-bottom pb-2">ê²Œì‹œê¸€ ì‘ì„±</h5>

  <form th:object="${boardForm}" method="post">
    <input type="hidden" th:name="${_csrf.parameterName}" id="_csrf"
           th:value="${_csrf.token}" />

    <div th:replace="~{form_errors :: formErrorsFragment}"></div>

    <div class="mb-3">
      <label for="subject" class="form-label">ì œëª©</label>
      <input type="text" th:field="*{subject}" class="form-control">
    </div>

    <div class="mb-3">
      <label for="contents" class="form-label">ë‚´ìš©</label>
      <div id="contents" name="contents" class="form-control"></div>
      <input type="hidden" name="contents" id="ecp">
      <input type="hidden" id="ecp1" th:field="*{contents}">
    </div>

    <div class="d-flex align-items-center">
      <button type="button" id="aiBtn" class="btn btn-outline-secondary my-2">AI</button>
      <div class="ms-auto d-flex gap-2">
        <input type="submit" value="í™•ì¸" class="btn btn-info my-2">
        <a class="btn btn-outline-info my-2" th:href="@{/board/list}">ì·¨ì†Œ</a>
      </div>
    </div>
  </form>

  <!-- ì˜¤ë²„ë ˆì´ -->
  <div id="aiOverlay"
       style="position:fixed; inset:0; z-index:9998; background:rgba(15,15,15,0.10);
              backdrop-filter:blur(6px); -webkit-backdrop-filter:blur(6px);
              opacity:0; transition:opacity .22s ease; display:none;"></div>

  <!-- AI ëª¨ë‹¬ -->
  <div id="aiPopup" role="dialog" aria-modal="true" aria-labelledby="aiTitle"
       style="position:fixed; z-index:9999; left:50%; top:50%;
              transform:translate(-50%,-50%) scale(0.98);
              width:min(92vw, 560px); max-height:86vh; overflow:hidden;
              border:1px solid rgba(255,255,255,0.28);
              border-radius:18px; padding:16px 16px 12px 16px;
              background:rgba(255,255,255,0.65);
              box-shadow:0 10px 30px rgba(0,0,0,0.18), 0 2px 8px rgba(0,0,0,0.08);
              backdrop-filter:saturate(180%) blur(16px);
              opacity:0; transition:opacity .22s ease, transform .22s ease;
              display:none;">
    <button id="aiPopupClose" aria-label="Close"
            style="position:absolute; top:10px; right:12px; width:32px; height:32px;
                   border-radius:999px; font-size:20px; cursor:pointer;">Ã—</button>

    <h3 id="aiTitle" style="margin:0 36px 10px 2px;">AI</h3>

    <div id="aiResponse"
         style="margin:0 2px 12px 2px; padding:12px; border-radius:14px;
                background:rgba(255,255,255,0.55); max-height:44vh; overflow:auto;"></div>

    <div class="ai-prompt-group mt-3" style="display:flex; gap:10px; align-items:flex-end;">
      <textarea id="aiPrompt" placeholder="ì…ë ¥"
                style="flex:1; min-height:72px; max-height:30vh; padding:12px; border-radius:14px;"></textarea>
      <button id="aiSendBtn"
              style="flex:0 0 auto; height:44px; padding:0 16px; border-radius:12px; border:none;
                     background:#0a84ff; color:#fff; font-weight:600; cursor:pointer;">ì „ì†¡</button>
    </div>
  </div>
</div>

<script layout:fragment="script" type="text/javascript" th:inline="javascript">
  // --- Toast UI Editor ì´ˆê¸°í™” ---
  const editor = new toastui.Editor({
    el: document.querySelector('#contents'),
    height: '500px',
    initialEditType: 'markdown',
    initialValue: '',
    previewStyle: 'vertical',
    placeholder: 'ë‚´ìš©ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.',
    hooks: {
      async addImageBlobHook(blob, callback) {
        try {
          const formData = new FormData();
          formData.append('image', blob);
          formData.append('type', "board");
          formData.append('mode',  /*[[${mode}]]*/'');

          const response = await fetch('/tui-editor/image-upload', {
            method: 'POST',
            body: formData,
            headers: { 'X-CSRF-Token': $('#_csrf').attr('value') },
          });

          const json = await response.json();
          const imageUrl = `/tui-editor/image-print?filename=${json.saveFilename}`;
          callback(imageUrl, 'image alt attribute');
        } catch (error) {
          console.error('ì—…ë¡œë“œ ì‹¤íŒ¨ : ', error);
        }
      },
    },
  });

  // ì„œë²„ì—ì„œ ë°›ì€ ê¸°ì¡´ ë‚´ìš© ì„¸íŒ…
  editor.setMarkdown(document.querySelector('#ecp1').value);

  // --- í¼ ì œì¶œ ì‹œ editor ë‚´ìš© ìˆ¨ê¹€ í•„ë“œì— ë„£ê¸° ---
  document.querySelector('form').addEventListener('submit', function(event) {
    document.querySelector('#ecp1').value = '';
    const content = editor.getMarkdown();
    const encodedC = encodeURIComponent(content);
    document.querySelector('#ecp').value = encodedC;
  });

  // --- AI ê´€ë ¨ ìƒíƒœ ---
  const AI_HISTORY_KEY = 'aiHistory';
  let aiHistory = JSON.parse(localStorage.getItem(AI_HISTORY_KEY)) || [];
  let lastUserPrompt = '';
  let isAiRequesting = false;
  let aiAbortController = null;

  // ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸
  function getPromptBySkin() {
    return [
      "ì½”ë“œë„ìš°ë¯¸",
      "í…ìŠ¤íŠ¸ ë°›ì€ë‚´ìš©ì„ í•´ì„í•˜ê±°ë‚˜ í’€ì´í•˜ëŠ”ê±¸ ì¤‘ì ìœ¼ë¡œ í•œë‹¤.",
      "ìœ„ì— ì¨ì ¸ìˆëŠ” í…ìŠ¤íŠ¸ë¥¼ ì¤‘ì‹¬ìœ¼ë¡œ ëŒ€í™”í•œë‹¤.",
      "[ì¤‘ìš”] ë‹µë³€ì€ í•­ìƒ ì •í™•íˆ 5ì¤„ë¡œ ì œí•œí•œë‹¤."
    ].join("\n");
  }

  // AI ì‘ë‹µ í‘œì‹œ
  function showAiResponse(text) {
    document.getElementById('aiResponse').innerHTML =
      '<div style="font-size:12px;color:#6b7280;margin-bottom:8px;">[ëª…ë ¹] '
      + (lastUserPrompt || '')
      + '</div><div>' + (text || '') + '</div>';
  }

  function saveAiHistory() {
    localStorage.setItem(AI_HISTORY_KEY, JSON.stringify(aiHistory));
  }

  function loadAiHistory() {
    aiHistory = JSON.parse(localStorage.getItem(AI_HISTORY_KEY)) || [
      { role: 'user', parts: [{ text: getPromptBySkin() }] }
    ];
  }

  // --- ëª¨ë‹¬ ì—´ê¸°/ë‹«ê¸° ---
  function openAiModal() {
    const overlay = document.getElementById('aiOverlay');
    const popup = document.getElementById('aiPopup');
    const prompt = document.getElementById('aiPrompt');
    overlay.style.display = 'block';
    popup.style.display = 'block';
    void overlay.offsetHeight; void popup.offsetHeight;
    overlay.style.opacity = '1';
    popup.style.opacity = '1';
    popup.style.transform = 'translate(-50%,-50%) scale(1)';
    document.body.style.overflow = 'hidden';
    setTimeout(()=>{ try{ prompt && prompt.focus(); }catch(e){} }, 80);
  }

  function closeAiModal() {
    const overlay = document.getElementById('aiOverlay');
    const popup = document.getElementById('aiPopup');
    overlay.style.opacity = '0';
    popup.style.opacity = '0';
    popup.style.transform = 'translate(-50%,-50%) scale(0.98)';
    setTimeout(()=>{
      overlay.style.display = 'none';
      popup.style.display = 'none';
      document.body.style.overflow = '';
    }, 220);
  }

  document.addEventListener('DOMContentLoaded', function() {
    const overlay = document.getElementById('aiOverlay');
    if (overlay) overlay.addEventListener('click', closeAiModal);
  });

  // --- ë²„íŠ¼ ì´ë²¤íŠ¸ ---
  document.getElementById('aiBtn').addEventListener('click', function() {
    openAiModal();
    isAiRequesting = false;
    aiAbortController = null;
  });

  document.getElementById('aiPopupClose').addEventListener('click', function() {
    closeAiModal();
  });

  document.getElementById('aiSendBtn').addEventListener('click', async function() {
    lastUserPrompt = document.getElementById('aiPrompt').value;

    if (isAiRequesting) {
      if (aiAbortController) aiAbortController.abort();
      isAiRequesting = false;
      showAiResponse('ìš”ì²­ì´ ì¤‘ì§€ë˜ì—ˆìŠµë‹ˆë‹¤.');
      return;
    }

    isAiRequesting = true;
    aiAbortController = new AbortController();

    // ğŸ“Œ editor ë‚´ìš© ê°€ì ¸ì˜¤ê¸°
    const pageContent = editor.getMarkdown();

    aiHistory = [
      { role: 'user', parts: [{ text: getPromptBySkin() }] },
      { role: 'user', parts: [{ text: pageContent }] },
      { role: 'user', parts: [{ text: lastUserPrompt || '' }] }
    ];

    saveAiHistory();
    document.getElementById('aiPrompt').value = '';
    showAiResponse('ì‘ë‹µì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...');

    try {
      const csrfToken = document.getElementById('_csrf')?.value || '';
      const response = await fetch('/api/ai/gemini', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRF-Token': csrfToken },
        body: JSON.stringify({ contents: aiHistory }),
        signal: aiAbortController.signal
      });

      const data = await response.json();
      const aiText = data?.candidates?.[0]?.content?.parts?.[0]?.text || 'ì‘ë‹µì´ ì—†ìŠµë‹ˆë‹¤.';
      showAiResponse(aiText);
      aiHistory.push({ role: 'model', parts: [{ text: aiText }] });
      saveAiHistory();
    } catch (e) {
      showAiResponse('ì—ëŸ¬ ë°œìƒ: ' + e.message);
    } finally {
      isAiRequesting = false;
    }
  });

  // --- ì´ˆê¸°í™” ---
  loadAiHistory();
</script>

</html>
