<!DOCTYPE html>
<html layout:decorate="~{layout}" xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout">
<head>
<meta name="_csrf" th:content="${_csrf.token}" />
<meta name="_csrf_header" th:content="${_csrf.headerName}" />
<title>비밀번호 찾기</title>
</head>
<div layout:fragment="content" class="container my-3">

	<h1>비밀번호를 잊으셨나요?</h1>
	<p>가입한 이메일 주소를 입력해 주시면, 비밀번호를 재설정할 수 있는 링크를 보내드립니다.</p>

	<form id="resetPasswordForm">
		<div>
			<label for="email">이메일:</label> <input type="email" id="email"
				name="email" required>
		</div>
		<button type="submit">이메일 보내기</button>
	</form>

	<p id="message"></p>

</div>

<script layout:fragment="script" type="text/javascript"
	th:inline="javascript">
        document.getElementById('resetPasswordForm').addEventListener('submit', function(event) {
            event.preventDefault();
            const email = document.getElementById('email').value;

            // HTML에서 CSRF 토큰과 헤더 이름 가져오기
            const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
            const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');


            fetch('/api/send-reset-password', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                       [csrfHeader]: csrfToken 
                        //헤더와 토큰을 추가
                },
                body: JSON.stringify({ email: email })
            })
            .then(response => {
                if (!response.ok) {
                    // 오류 응답 처리
                    throw new Error('사용자를 찾을 수 없습니다.');
                }
                return response.json();
            })
            .then(data => {
                document.getElementById('message').innerText = '비밀번호 재설정 이메일이 발송되었습니다.';
                alert('비밀번호 재설정 이메일이 발송되었습니다.');
                console.log('UUID:', data.uuid);
            })
            .catch(error => {
                document.getElementById('message').innerText = error.message;
            });
        });
    </script>
</html>