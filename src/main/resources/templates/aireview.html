<!DOCTYPE html>
<html layout:decorate="~{layout}" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <title>AI 코드 도우미</title>
</head>
<body>
<div layout:fragment="content" class="container my-3">
    <input type="hidden" th:name="${_csrf.parameterName}"
           th:value="${_csrf.token}" id="_csrf" />

    <h5 class="border-bottom pb-2">AI 코드 도우미</h5>

    <!-- 코드 입력 -->
    <div id="editorContainer">
        <textarea id="codeInput" placeholder="코드를 입력하세요." rows="10" class="form-control"></textarea>
        <button id="aiBtn" class="btn btn-info mt-2">AI에게 물어보기</button>
    </div>

    <!-- AI 답변 -->
    <div id="aiContainer" style="display:none;">
        <h5 class="border-bottom pb-2">AI 답변</h5>

        <div class="mb-2">
            <strong>코드 종류</strong>
            <div id="codeType" class="border rounded p-2 bg-light"></div>
        </div>

        <div class="mb-2">
            <strong>작동여부</strong>
            <div id="codeStatus" class="border rounded p-2 bg-light"></div>
        </div>

        <div class="mb-2">
            <strong>코드 리뷰</strong>
            <div id="codeReview" class="border rounded p-2 bg-white"></div>
        </div>

        <div class="mb-2">
            <strong>개선사항</strong>
            <div id="codeImprovements" class="border rounded p-2 bg-white"></div>
        </div>

        <button id="backToEditorBtn" class="btn btn-secondary">다시 물어보기</button>
    </div>
</div>

<!-- 개별 페이지 스크립트 -->
<th:block layout:fragment="script">
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const editorContainer = document.getElementById('editorContainer');
        const aiContainer = document.getElementById('aiContainer');
        const aiBtn = document.getElementById('aiBtn');
        const backBtn = document.getElementById('backToEditorBtn');
        const codeInput = document.getElementById('codeInput');

        let isAiRequesting = false;

        function getPromptBySkin() {
            return [
                "[중요] 코드 리뷰어로써 답변을 해줘야함",
                "[중요] 줄바꿈은 처리는 html 종류로 할것",
                "[중요] 줄바꿈은 <br>태그로 html 양식에 맞게 할것",
                "가독성을 위해 마침표마다 줄바꿈을 할 것",
                "이 코드의 종류를 최상단'|codetype|코드종류|codetype|' 으로 기재해준다. (파싱용)",
                "이 코드의 작동여부를 2번째줄'|codestatus|코드작동여부|codestatus|' 으로 기재해준다. (파싱용)",
                "이 코드의 리뷰에 관한 내용을 3번째줄'|codecontent|코드리뷰|codecontent|' 으로 기재해준다. (파싱용)",
                "이 코드의 개선사항을 4번째줄'|codeimprovements|코드 개선사항|codeimprovements|' 으로 기재해준다. (파싱용)",
                "[최우선 중요] 위에 파싱용 규칙 외에는 절대 글이 써지면 안된다. 기본적인 글은 |codecontent| 에다가 쓰면 된다.",
                "각 항목에 맞게끔 내용 넣어줘. 상호간에 중복이 안되게."
            ].join("\n");
        }

        function extractBetween(text, startTag, endTag) {
            if (!text) return '';
            const escapedStartTag = startTag.replace(/\|/g, '\\|');
            const escapedEndTag = endTag.replace(/\|/g, '\\|');
            const regex = new RegExp(`${escapedStartTag}\\s*(.*?)\\s*${escapedEndTag}`, 's');
            const match = text.match(regex);
            return match ? match[1].trim() : '';
        }

        aiBtn.addEventListener('click', async function() {
            const userInput = codeInput.value;
            if (!userInput.trim()) return;

            editorContainer.style.display = 'none';
            aiContainer.style.display = 'block';

            document.getElementById('codeType').textContent = '불러오는 중...';
            document.getElementById('codeStatus').textContent = '';
            document.getElementById('codeReview').textContent = '';
            document.getElementById('codeImprovements').textContent = '';

            if (isAiRequesting) return;
            isAiRequesting = true;

            try {
                const csrfToken = document.getElementById('_csrf').value;
                const response = await fetch('/api/ai/gemini', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-Token' : csrfToken
                    },
                    body: JSON.stringify({
                        contents:[
                            { role:'user', parts:[{text:getPromptBySkin()}] },
                            { role:'user', parts:[{text:userInput}] }
                        ]
                    })
                });
                const data = await response.json();
                const aiText = data?.candidates?.[0]?.content?.parts?.[0]?.text || '';

                document.getElementById('codeType').textContent = extractBetween(aiText, '|codetype|', '|codetype|');
                document.getElementById('codeStatus').textContent = extractBetween(aiText, '|codestatus|', '|codestatus|');
                document.getElementById('codeReview').innerHTML = extractBetween(aiText, '|codecontent|', '|codecontent|');
                document.getElementById('codeImprovements').innerHTML = extractBetween(aiText, '|codeimprovements|', '|codeimprovements|');

            } catch(e) {
                document.getElementById('codeType').textContent = '';
                document.getElementById('codeStatus').textContent = '';
                document.getElementById('codeReview').textContent = '에러 발생: ' + e.message;
                document.getElementById('codeImprovements').textContent = '';
            } finally {
                isAiRequesting = false;
            }
        });

        backBtn.addEventListener('click', function() {
            aiContainer.style.display = 'none';
            editorContainer.style.display = 'block';
        });
    });
</script>
</th:block>
</body>
</html>
