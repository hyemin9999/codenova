<!DOCTYPE html>
<html layout:decorate="~{layout}" xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <title>AI 코드 도우미</title>
</head>
<body>

<div layout:fragment="content" class="container my-3">
	<input type="hidden" th:name="${_csrf.parameterName}"
		th:value="${_csrf.token}" id="_csrf" />
    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #fdfcfb, #f5f7fa);
            padding: 20px;
            color: #333;
        }

        h5 {
            font-weight: 600;
            color: #222;
            margin-bottom: 12px;
            font-size: 1.2rem;
        }

        textarea {
            width: 100%;
            border-radius: 14px;
            border: 1px solid #e0e0e0;
            padding: 14px;
            font-size: 15px;
            background: #fff;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
        }

        textarea:focus {
            outline: none;
            border: 1px solid #a5c9ff;
            box-shadow: 0 4px 12px rgba(165, 201, 255, 0.3);
        }

        #aiContainer {
            display: none;
        }

        .aiBox {
            border-radius: 16px;
            padding: 14px;
            margin-bottom: 14px;
            background: #ffffffd9;
            box-shadow: 0 4px 14px rgba(0, 0, 0, 0.05);
            font-size: 15px;
            color: #444;
            backdrop-filter: blur(8px);
        }

        #codeType {
            font-size: 0.95em;
            color: #5c6bc0;
            font-weight: 500;
        }

        #codeStatus {
            font-size: 0.9em;
            color: #2e7d32;
            font-weight: 500;
        }

        #codeReview {
            background: #fdf9ff;
            border: 1px solid #e0d7f7;
        }

        #codeImprovements {
            background: #fefaf4;
            border: 1px solid #f5d9b3;
        }

        .btn {
            margin-top: 10px;
            border-radius: 12px;
            padding: 10px 18px;
            font-size: 15px;
            font-weight: 600;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, #7ec8ff, #9dd8ff);
            color: #fff;
            box-shadow: 0 4px 12px rgba(126, 200, 255, 0.4);
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #69b8ff, #89cfff);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #f3f4f6, #e7e9ec);
            color: #555;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
        }

        .btn-secondary:hover {
            background: linear-gradient(135deg, #e4e6e9, #d9dbde);
        }

    </style>

<div id="editorContainer">
    <h5>코드 입력</h5>
    <textarea id="codeInput" placeholder="코드를 입력하세요." rows="10"></textarea>
    <button id="aiBtn" class="btn btn-primary">AI에게 물어보기</button>
</div>

<div id="aiContainer">
    <h5>AI 답변</h5>

    <div>당신의 성격</div>
    <div id="codeType" class="aiBox"></div>

    <div>당신의 성향</div>
    <div id="codeStatus" class="aiBox"></div>

    <div>당신의 MBTI</div>
    <div id="codeReview" class="aiBox"></div>

    <div>당신에 대한 전반적인 리뷰</div>
    <div id="codeImprovements" class="aiBox"></div>

    <button id="backToEditorBtn" class="btn btn-secondary">다시 물어보기</button>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const editorContainer = document.getElementById('editorContainer');
        const aiContainer = document.getElementById('aiContainer');
        const aiBtn = document.getElementById('aiBtn');
        const backBtn = document.getElementById('backToEditorBtn');
        const codeInput = document.getElementById('codeInput');

        let isAiRequesting = false;

        function getPromptBySkin() {
            return [
                "[중요] 성격 파악자로써 답변을 해줘야함",
                "[중요] 줄바꿈은 처리는 html 종류로 할것",
                "[중요] 줄바꿈은 <br>태그로 html 양식에 맞게 할것",
                "가독성을 위해 마침표마다 줄바꿈을 할 것",
                "이 코드를 쓴 사람의 성격을 최상단'|codetype|성격|codetype|' 으로 기재해준다. (파싱용)",
                "이 코드를 쓴 사람의 성향을 2번째줄'|codestatus|성향|codestatus|' 으로 기재해준다. (파싱용)",
                "이 코드를 쓴 사람의 MBTI 3번째줄'|codecontent|MBTI|codecontent|' 에다가 제일 가능성 높은 한개만 기재해준다. (파싱용)",
                "이 코드를 쓴 사람의 종합적인 인간적 평가를'|codeimprovements|사람평가|codeimprovements|' 으로 기재해준다. (파싱용)",
                "[최우선 중요] 위에 파싱용 규칙 외에는 절대 글이 써지면 안된다. 기본적인 글은 |codecontent| 에다가 쓰면 된다.",
                "각 항목에 맞게끔 내용 넣어줘. 상호간에 중복이 안되게.",
                "코드에 대한 답변이 아닌, 인간에 대한 분석과 답변임."

            ].join("\n");
        }

        function extractBetween(text, startTag, endTag) {
        	console.log("파싱시작");
            if (!text) return '';
            // 파이프(|) 문자를 이스케이프 처리
            const escapedStartTag = startTag.replace(/\|/g, '\\|');
            const escapedEndTag = endTag.replace(/\|/g, '\\|');
            const regex = new RegExp(`${escapedStartTag}\\s*(.*?)\\s*${escapedEndTag}`, 's');
            const match = text.match(regex);
            return match ? match[1].trim() : '';
        }

        aiBtn.addEventListener('click', async function() {
            const userInput = codeInput.value;
            if (!userInput.trim()) return;

            editorContainer.style.display = 'none';
            aiContainer.style.display = 'block';

            // 초기화 및 로딩 상태 표시
            document.getElementById('codeType').textContent = '불러오는 중...';
            document.getElementById('codeStatus').textContent = '';
            document.getElementById('codeReview').textContent = '';
            document.getElementById('codeImprovements').textContent = '';

            if (isAiRequesting) return;
            isAiRequesting = true;

            try {
              
                const response = await fetch('/api/ai/gemini', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-Token' : $('#_csrf').attr('value')
                      },
                    body: JSON.stringify({ contents:[
                            { role:'user', parts:[{text:getPromptBySkin()}] },
                            { role:'user', parts:[{text:userInput}] }
                        ]})
                });
                const data = await response.json();
                const aiText = data?.candidates?.[0]?.content?.parts?.[0]?.text || '';

                // 각 div에 파싱하여 내용 업데이트
                document.getElementById('codeType').textContent = extractBetween(aiText, '|codetype|', '|codetype|');
                document.getElementById('codeStatus').textContent = extractBetween(aiText, '|codestatus|', '|codestatus|');
                document.getElementById('codeReview').innerHTML = extractBetween(aiText, '|codecontent|', '|codecontent|');
                document.getElementById('codeImprovements').innerHTML = extractBetween(aiText, '|codeimprovements|', '|codeimprovements|');

            } catch(e) {
                document.getElementById('codeType').textContent = '';
                document.getElementById('codeStatus').textContent = '';
                document.getElementById('codeReview').textContent = '에러 발생: ' + e.message;
                document.getElementById('codeImprovements').textContent = '';
            } finally {
                isAiRequesting = false;
            }
        });

        backBtn.addEventListener('click', function() {
            aiContainer.style.display = 'none';
            editorContainer.style.display = 'block';
        });
    });
</script>


</div>

</body>
</html>